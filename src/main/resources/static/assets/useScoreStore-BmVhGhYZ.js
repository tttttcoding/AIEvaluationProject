import{s as M,E as a,b as O,d as z,g as j,r as n}from"./index-uf0FIciC.js";import{u as x,b as E,c as G,d as W}from"./ToolsService-Cj2k-usM.js";import{u as X}from"./useSelectedToolStore-DTE7_rlX.js";const B=async(m,i)=>{try{return(await M.post(`/evaluation/upload/${i}`,m,{headers:{"Content-Type":"multipart/form-data"}})).data}catch(r){if(r.response)switch(r.response.status){case 401:a.error("登录状态过期，请重新登录!"),localStorage.removeItem("user"),O.push("/form");break;case 403:a.error("没有权限访问");break;case 404:a.error("请求的资源不存在");break;case 500:a.error("服务器内部错误");break;default:a.error(`请求失败: ${r.message}`)}return Promise.reject(r)}},K=async(m,i)=>{try{const r=await M.post(`/evaluation/${i}`,{Authorization:m});return{message:r.data.message,status:r.status}}catch(r){if(r.response)switch(r.response.status){case 401:a.error("登录状态过期，请重新登录!"),localStorage.removeItem("user"),O.push("/form");break;case 403:a.error("没有权限访问");break;case 404:a.error("请求的资源不存在");break;case 500:a.error("服务器内部错误");break;default:a.error(`请求失败: ${r.message}`)}return Promise.reject(r)}},ee=z("score",()=>{const m=j();X();const i=n(""),r=n(null),p=n(!1),S=n(""),U=n([]),d=n(!1),w=n([{name:"内容质量",percent:.3,score:0,criteria:["表达清晰：生成内容易懂、逻辑清晰","创意能力：提供创新性的答案或富有变化的内容","上下文理解：能否根据历史输入调整生成结果，提高连贯性","事实准确性：是否提供错误或误导性内容"],basis:""},{name:"性能高效性",percent:.25,score:0,criteria:["结果精准：生成的结果符合或超出预期","响应速度：用户指令下达后能快速生成结果","运行稳定：不卡顿、不崩溃","核心功能完备：具备同类产品核心功能"],basis:""},{name:"操作便捷性",percent:.25,score:0,criteria:["界面交互：美观简洁，功能易查找","新手引导：提供教程或文档，帮助快速熟悉","多端兼容：支持电脑、手机、平板同步使用","个性化设置：可根据用户偏好调整 AI 行为"],basis:""},{name:"付费合理性",percent:.1,score:0,criteria:["免费使用：提供免费版本，主要功能可试用","定价合理：价格在可接受范围","价格匹配：付费功能质量与价格相符","价格灵活：提供多种套餐或功能模块收费"],basis:""},{name:"服务反馈水平",percent:.1,score:0,criteria:["用户反馈：提供反馈通道，客服响应及时","隐私保护：清晰告知数据收集情况","产品活跃性：定期更新，优化性能，采纳用户反馈","用户社区活跃度：有社区供提问、交流、分享"],basis:""}]),k=n({username:"默认",tool:"默认",category:"默认",averageScore:0,comment:""}),u=n(null),T=e=>{if(!u.value)return!0;const t=Date.now(),s=10*1e3;if(u.value.fileName===e&&t-u.value.timestamp<s){const o=Math.ceil((s-(t-u.value.timestamp))/1e3);return a.warning(`请求过于频繁，请等待 ${o} 秒后再次上传`),!1}return!0},A=e=>{const t=e.target.files;t&&t.length>0&&(r.value=t[0],S.value=t[0].name)},f=n(0),D=1*1024*1024;function F(e){const t=[];let s=0;for(;s<e.size;){const o=Math.min(s+D,e.size);t.push(e.slice(s,o)),s=o}return t}const J=async()=>{try{if(p.value=!0,!r.value){a.warning("请选择文件");return}if(!T(r.value.name))return;const e=JSON.parse(localStorage.getItem("user")).token;u.value={timestamp:Date.now(),fileName:r.value.name};let t=null,s=null;const o=F(r.value),h=o.length;for(let c=0;c<o.length;c++){const l=new FormData;l.append("Authorization",e),l.append("file",o[c]),l.append("fileSum",String(h)),t=await B(l,c+1),f.value=Math.round((c+1)/h*100),c===o.length-1&&(s=t.message)}if(s){let l=0;const $=async()=>{try{const y=JSON.parse(localStorage.getItem("selectedTool")).id,R=await K(e,y);return R.status===200?(a.info("评估结果获取成功"),i.value=JSON.parse(R.message),!0):(f.value=100,a.info("正在解析结果，请稍候"),!1)}catch{return console.log("轮询出错，继续尝试"),!1}},H=setInterval(async()=>{l++,await $()?(a.success("评估完成"),clearInterval(H),p.value=!1,_()):l>=60&&(clearInterval(H),p.value=!1,a.error("评估超时，请缩减文件大小"))},3e3)}}catch(e){console.error(e),p.value=!1,a.error("上传过程中发生错误")}},_=()=>{setTimeout(()=>{m.push("/result")},700)},v=n({}),C=async e=>{const s={rating:b(),comment:k.value.comment},o=JSON.parse(localStorage.getItem("user")).token;try{await x(o,s,e),a.success("评分上传成功"),await I(e)}catch{a.error("评分上传失败")}},I=async e=>{try{v.value={};const t=await E(e);return v.value=t,t}catch{a.error("工具详情获取失败")}},b=()=>{const e=[.3,.25,.25,.1,.1];let t=0;return w.value.forEach((s,o)=>{t+=s.score*e[o]}),parseFloat(t.toFixed(1))},g=n([]),P=async()=>{try{await Promise.all(g.value.map(async e=>{e.rate_time=e.rate_time.replace("T"," ");const t=await E(Number(e.tool_id));return e.tool_name=t.name||"未知工具",e.tool_category=t.category||"未知类别",{...e}}))}catch{a.error("格式化历史评分记录失败")}},N=async()=>{const e=JSON.parse(localStorage.getItem("user")).token;d.value=!0;try{const t=await G(e);g.value=t.rates,console.log(g.value),await P(),d.value=!1,console.log("历史评分记录获取成功")}catch{a.error("历史评分记录获取失败")}};return{rateStandards:w,rate:k,progress:f,userFile:r,uploading:p,toolsDetail:v,userFileName:S,reportHistory:U,loadingHistory:d,lastUploadRecord:u,historyRates:g,evalData:i,checkThrottle:T,handleUpload:J,handleUserFileChange:A,ToolsDetailGet:I,deleteRate:async e=>{const t=JSON.parse(localStorage.getItem("user")).token;try{let s=await W(t,e);(s==null?void 0:s.message)==="删除成功"&&a.success("评论撤回成功"),await N()}catch{a.error("评论撤回失败")}},fetchHistoryRates:N,evaluationTransmission:C,calculateWeightedAverage:b,checkUploadCount:e=>(JSON.parse(localStorage.getItem("uploadHistory")||"{}")[e]||0)<2,recordUpload:e=>{const t=JSON.parse(localStorage.getItem("uploadHistory")||"{}");t[e]=(t[e]||0)+1,localStorage.setItem("uploadHistory",JSON.stringify(t))}}});export{ee as u};
