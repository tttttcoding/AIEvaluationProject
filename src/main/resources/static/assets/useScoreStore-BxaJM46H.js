import{s as D,E as a,a as T,d as z,f as P,r as c}from"./index-ZCHI1N3d.js";import{u as U,b as I,c as $,d as B}from"./ToolsService-Bx7cvXeC.js";const j=async(m,s)=>{try{return(await D.post(`/evaluation/upload/${s}`,m,{headers:{"Content-Type":"multipart/form-data"}})).data}catch(o){if(o.response)switch(o.response.status){case 401:a.error("登录状态过期，请重新登录!"),localStorage.removeItem("user"),T.push("/form");break;case 403:a.error("没有权限访问");break;case 404:a.error("请求的资源不存在");break;case 500:a.error("服务器内部错误");break;default:a.error(`请求失败: ${o.message}`)}else o.code==="ECONNABORTED"&&a.error("请求超时，请检查网络连接");return Promise.reject(o)}},x=async m=>{try{const s=await D.post("/evaluation",{Authorization:m});return{message:s.data.message,status:s.status}}catch(s){if(s.response)switch(s.response.status){case 401:a.error("登录状态过期，请重新登录!"),localStorage.removeItem("user"),T.push("/form");break;case 403:a.error("没有权限访问");break;case 404:a.error("请求的资源不存在");break;case 500:a.error("服务器内部错误");break;default:a.error(`请求失败: ${s.message}`)}else s.code==="ECONNABORTED"&&a.error("请求超时，请检查网络连接");return Promise.reject(s)}},V=z("score",()=>{const m=P(),s=c(""),o=c(null),f=c(!1),w=c(""),O=c([]),v=c(!1),S=c([{name:"内容质量",percent:.3,score:0,criteria:["表达清晰：生成内容易懂、逻辑清晰","创意能力：提供创新性的答案或富有变化的内容","上下文理解：能否根据历史输入调整生成结果，提高连贯性","事实准确性：是否提供错误或误导性内容"],basis:""},{name:"性能高效性",percent:.25,score:0,criteria:["结果精准：生成的结果符合或超出预期","响应速度：用户指令下达后能快速生成结果","运行稳定：不卡顿、不崩溃","核心功能完备：具备同类产品核心功能"],basis:""},{name:"操作便捷性",percent:.25,score:0,criteria:["界面交互：美观简洁，功能易查找","新手引导：提供教程或文档，帮助快速熟悉","多端兼容：支持电脑、手机、平板同步使用","个性化设置：可根据用户偏好调整 AI 行为"],basis:""},{name:"付费合理性",percent:.1,score:0,criteria:["免费使用：提供免费版本，主要功能可试用","定价合理：价格在可接受范围","价格匹配：付费功能质量与价格相符","价格灵活：提供多种套餐或功能模块收费"],basis:""},{name:"服务反馈水平",percent:.1,score:0,criteria:["用户反馈：提供反馈通道，客服响应及时","隐私保护：清晰告知数据收集情况","产品活跃性：定期更新，优化性能，采纳用户反馈","用户社区活跃度：有社区供提问、交流、分享"],basis:""}]),k=c({username:"默认",tool:"默认",category:"默认",averageScore:0,comment:""}),i=c(null),b=t=>{if(!i.value)return!0;const e=Date.now(),r=10*1e3;if(i.value.fileName===t&&e-i.value.timestamp<r){const n=Math.ceil((r-(e-i.value.timestamp))/1e3);return a.warning(`请求过于频繁，请等待 ${n} 秒后再次上传`),!1}return!0},F=t=>{const e=t.target.files;e&&e.length>0&&(o.value=e[0],w.value=e[0].name)},h=c(0),A=1*1024*1024;function C(t){const e=[];let r=0;for(;r<t.size;){const n=Math.min(r+A,t.size);e.push(t.slice(r,n)),r=n}return e}const H=async()=>{if(!o.value){a.warning("请选择文件");return}if(!b(o.value.name))return;const t=JSON.parse(localStorage.getItem("user")).token;f.value=!0;try{i.value={timestamp:Date.now(),fileName:o.value.name};let e=null,r=null;const n=C(o.value),y=n.length;for(let l=0;l<n.length;l++){const u=new FormData;u.append("Authorization",t),u.append("file",n[l]),u.append("fileSum",String(y)),e=await j(u,l+1),h.value=Math.round((l+1)/y*100),l===n.length-1&&(r=e.message)}if(r){const l=async()=>{try{const g=await x(t);return g.status===200?(a.info("评估结果获取成功"),s.value=JSON.parse(g.message),console.log(s.value),!0):(h.value=100,a.info("正在轮询"),!1)}catch{return console.log("未知错误,继续轮询"),!1}},u=setInterval(async()=>{await l()&&(a.success("评估完成"),clearInterval(u),f.value=!1,M())},3e3)}}catch(e){console.error(e)}},M=()=>{setTimeout(()=>{m.push("/result")},800)},d=c({}),_=async t=>{const r={rating:R(),comment:k.value.comment},n=JSON.parse(localStorage.getItem("user")).token;try{await U(n,r,t),a.success("评分上传成功"),await N(t)}catch{a.error("评分上传失败")}},N=async t=>{try{d.value={};const e=await I(t);return d.value=e,e}catch{a.error("工具详情获取失败")}},R=()=>{const t=[.3,.25,.25,.1,.1];let e=0;return S.value.forEach((r,n)=>{e+=r.score*t[n]}),parseFloat(e.toFixed(1))},p=c([]),J=async()=>{try{await Promise.all(p.value.map(async t=>{t.rate_time=t.rate_time.replace("T"," ");const e=await I(Number(t.tool_id));return t.tool_name=e.name||"未知工具",t.tool_category=e.category||"未知类别",{...t}}))}catch{a.error("格式化历史评分记录失败")}},E=async()=>{const t=JSON.parse(localStorage.getItem("user")).token;v.value=!0;try{const e=await $(t);p.value=e.rates,console.log(p.value),await J(),v.value=!1,a.success("历史评分记录获取成功")}catch{a.error("历史评分记录获取失败")}};return{rateStandards:S,rate:k,progress:h,userFile:o,uploading:f,toolsDetail:d,userFileName:w,reportHistory:O,loadingHistory:v,lastUploadRecord:i,historyRates:p,evalData:s,checkThrottle:b,handleUpload:H,handleUserFileChange:F,ToolsDetailGet:N,deleteRate:async t=>{const e=JSON.parse(localStorage.getItem("user")).token;try{let r=await B(e,t);(r==null?void 0:r.message)==="删除成功"&&a.success("评论删除成功"),await E()}catch{a.error("评论删除失败")}},fetchHistoryRates:E,evaluationTransmission:_,calculateWeightedAverage:R}});export{V as u};
