import{d as r}from"./index-cI5jML3S.js";import{g as l,a as c}from"./ToolsService-DSsT47uS.js";const h=r("tools",{state:()=>({categories:[],toolsByCategory:{},isLoading:!1,loadedCategories:new Set,loadedToolsCount:0,totalToolsCount:0,CACHE_TIME:30*1e3}),actions:{async loadFromCache(){const t=localStorage.getItem("toolCategories"),a=localStorage.getItem("toolsByCategory");if(t&&a)try{const e=JSON.parse(t),o=JSON.parse(a);return e!=null&&e.length?(this.categories=e,this.toolsByCategory=o,this.loadedCategories=new Set(e),this.loadedToolsCount=Object.values(this.toolsByCategory).reduce((s,i)=>s+i.length,0),this.totalToolsCount=Object.values(this.toolsByCategory).reduce((s,i)=>s+i.length,0),!0):!1}catch(e){console.error("缓存数据解析失败:",e)}return!1},saveToCache(){try{this.categories.length>0&&(localStorage.setItem("toolCategories",JSON.stringify(this.categories)),localStorage.setItem("toolsByCategory",JSON.stringify(this.toolsByCategory)),localStorage.setItem("toolsCacheTime",Date.now().toString()))}catch(t){console.error("保存缓存失败:",t)}},isCacheExpired(){const t=localStorage.getItem("toolsCacheTime");return!t||Date.now()-parseInt(t)>this.CACHE_TIME},async loadToolsForCategories(t,a=!1){a||(this.isLoading=!0);try{for(const e of t)if(!this.loadedCategories.has(e)){const o=await c(e);o!=null&&o.tools&&(this.toolsByCategory[e]=o.tools.map(this.mapTool),this.loadedCategories.add(e),this.loadedToolsCount+=o.tools.length,this.totalToolsCount=Object.values(this.toolsByCategory).reduce((s,i)=>s+i.length,0),a||this.saveToCache())}}catch(e){throw console.error("加载工具失败:",e),e}finally{a||(this.isLoading=!1)}},async loadInitialCategories(){this.categories.length&&await this.loadToolsForCategories(this.categories.slice(0,2))},async loadRemainingCategories(){this.categories.length&&(await this.loadToolsForCategories(this.categories.slice(2),!0),Object.keys(this.toolsByCategory).length===this.categories.length&&this.saveToCache())},async fetchCategory(){try{if(this.isLoading=!0,!this.isCacheExpired()&&await this.loadFromCache())return;const t=await l();t!=null&&t.categories&&(this.categories=t.categories,await this.loadInitialCategories(),await this.loadRemainingCategories())}catch(t){console.error("获取数据异常:",t),await this.loadFromCache()}finally{this.isLoading=!1}},mapTool(t){return{id:t.id,name:t.name,logo_url:t.logo_url,url:t.url,description:t.description,score:t.score,ratingCount:t.ratingCount,category:t.category}}}});export{h as u};
